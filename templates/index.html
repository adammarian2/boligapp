<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Ogłoszenia Finn & Hjem</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        canvas { max-width: 100%; margin: 30px 0; }
        form { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Ogłoszenia Finn &amp; Hjem</h1>

    <form method="get" action="/">
        <label for="city">Wybierz region:</label>
        <select id="city" name="city" onchange="this.form.submit()">
            {% for region in regions %}
                <option value="{{ region }}" {% if region == selected_region %}selected{% endif %}>
                    {{ region }}
                </option>
            {% endfor %}
        </select>
    </form>

    <h2>Finn</h2>
    <canvas id="finnChart" height="100"></canvas>

    <h2>Hjem</h2>
    <canvas id="hjemChart" height="100"></canvas>

    <h2>Suma (Finn + Hjem)</h2>
    <canvas id="sumChart" height="100"></canvas>

    <script>
    // Pobieramy dane i rysujemy wykresy
    document.addEventListener('DOMContentLoaded', () => {
        const selectedRegion = "{{ selected_region }}";

        fetch('/data')
            .then(res => res.json())
            .then(rows => {
                // filtrowanie po regionie
                const filtered = rows.filter(r => r.city === selectedRegion);
                // grupowanie po dacie
                const map = {};
                filtered.forEach(r => {
                    const d = r.date;
                    const f = parseInt(r.finn, 10) || 0;
                    const h = parseInt(r.hjem, 10) || 0;
                    const t = parseInt(r.total,10) || 0;
                    if (!map[d]) map[d] = { finn: 0, hjem: 0, total: 0 };
                    map[d].finn   += f;
                    map[d].hjem   += h;
                    map[d].total  += t;
                });
                // sortowanie dat
                const dates = Object.keys(map).sort();
                const finnData  = dates.map(d => map[d].finn);
                const hjemData  = dates.map(d => map[d].hjem);
                const sumData   = dates.map(d => map[d].total);

                // funkcja pomocnicza do tworzenia wykresu
                function createChart(ctxId, label, data, color) {
                    new Chart(
                        document.getElementById(ctxId).getContext('2d'),
                        {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: label,
                                    data: data,
                                    borderColor: color,
                                    backgroundColor: 'rgba(0,0,0,0)', 
                                    fill: false,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                scales: {
                                    x: { 
                                        title: { display: true, text: 'Data' } 
                                    },
                                    y: { 
                                        title: { display: true, text: 'Liczba ogłoszeń' },
                                        grid: { display: false }
                                    }
                                },
                                plugins: {
                                    legend: { display: true }
                                }
                            }
                        }
                    );
                }

                createChart('finnChart', 'Finn', finnData, '#0066CC');
                createChart('hjemChart', 'Hjem', hjemData, '#CC6600');
                createChart('sumChart',  'Suma', sumData,  '#333333');
            })
            .catch(err => console.error('Błąd pobierania danych:', err));
    });
    </script>
</body>
</html>
