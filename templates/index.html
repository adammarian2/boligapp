<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Boliger til salgs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 30px; background: #f7f7f7; }
    .controls { display: flex; gap: 20px; margin-bottom: 20px; }
    select, button { padding: 8px; font-size: 14px; }
    .charts { display: grid; grid-template-columns: 1fr; gap: 40px; }
    .chart-block { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .chart-block h2 { margin-bottom: 10px; }
    canvas { width: 100% !important; height: 300px !important; }
  </style>
</head>
<body>
  <h1>Totalt antall boliger til salgs</h1>

  <div class="controls">
    <select id="cityFilter">
      <option>Norge</option>
      <option>Oslo</option>
      <option>Agder</option>
      <option>Akershus</option>
      <option>Møre og Romsdal</option>
      <option>Trøndelag</option>
    </select>
    <select id="catFilter">
      <option value="ALL">Alle kategorier</option>
      <option value="leiligheter">Leiligheter</option>
      <option value="eneboliger">Eneboliger</option>
      <option value="tomter">Tomter</option>
    </select>
    <button id="refresh">Oppdater</button>
  </div>

  <div class="charts">
    <div class="chart-block">
      <h2>Finn.no</h2>
      <canvas id="chartFinn"></canvas>
    </div>
    <div class="chart-block">
      <h2>Hjem.no</h2>
      <canvas id="chartHjem"></canvas>
    </div>
    <div class="chart-block">
      <h2>Totalt</h2>
      <canvas id="chartTotal"></canvas>
    </div>
  </div>

  <script>
    async function loadData() {
      const res = await fetch('/data');
      const raw = await res.json();
      console.log('raw /data →', raw);
      return raw.map(r => ({
        date: r.date,
        city: r.city,
        category: r.category,
        finn: +r.finn,
        hjem: +r.hjem,
        total: +r.total
      }));
    }

    function filterData(data, city, cat) {
      return data.filter(d =>
        d.city === city &&
        (cat === 'ALL' || d.category === cat)
      );
    }

    function aggregate(data) {
      const byDate = {};
      data.forEach(d => {
        if (!byDate[d.date]) byDate[d.date] = { finn:0, hjem:0, total:0 };
        byDate[d.date].finn += d.finn;
        byDate[d.date].hjem += d.hjem;
        byDate[d.date].total += d.total;
      });
      const dates = Object.keys(byDate).sort();
      const series = {
        labels: dates,
        finn: dates.map(d => byDate[d].finn),
        hjem: dates.map(d => byDate[d].hjem),
        total: dates.map(d => byDate[d].total)
      };
      console.log('aggregated series →', series);
      return series;
    }

    let chartFinn, chartHjem, chartTotal;

    async function draw() {
      const raw = await loadData();
      const city = document.getElementById('cityFilter').value;
      const cat  = document.getElementById('catFilter').value;
      const filtered = filterData(raw, city, cat);
      const s = aggregate(filtered);

      const makeCfg = (label, dataArr, color, fill=false) => ({
        type: 'line',
        data: { labels: s.labels, datasets: [{
          label,
          data: dataArr,
          borderColor: color,
          backgroundColor: fill ? color + '33' : undefined,
          fill,
          tension: 0.1,
          pointRadius: 5
        }]},
        options: {
          responsive: true,
          scales: {
            x: { grid: false },
            y: { grid: false, beginAtZero: true }
          }
        }
      });

      [chartFinn, chartHjem, chartTotal].forEach(c => c && c.destroy());

      chartFinn  = new Chart(document.getElementById('chartFinn').getContext('2d'),
                             makeCfg('Finn.no', s.finn, 'blue'));
      chartHjem  = new Chart(document.getElementById('chartHjem').getContext('2d'),
                             makeCfg('Hjem.no', s.hjem, 'green'));
      chartTotal = new Chart(document.getElementById('chartTotal').getContext('2d'),
                             makeCfg('Totalt', s.total, 'pink', true));
    }

    document.getElementById('refresh').addEventListener('click', draw);
    window.addEventListener('load', draw);
  </script>
</body>
</html>
