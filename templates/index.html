<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Boliger til salgs i Norge</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 30px;
      background: #f7f7f7;
    }
    h1 {
      margin-bottom: 10px;
    }
    select {
      margin-right: 10px;
      padding: 6px;
      font-size: 1rem;
    }
    .stats {
      margin-bottom: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 300px;
    }
    canvas {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <h1>Boliger til salgs i Norge</h1>

  <div>
    <label>By:
      <select id="cityFilter">
        <option value="ALL">Alle</option>
      </select>
    </label>
    <label>Kategori:
      <select id="categoryFilter">
        <option value="ALL">Alle</option>
        <option value="leiligheter">Leiligheter</option>
        <option value="eneboliger">Eneboliger</option>
        <option value="tomter">Tomter</option>
      </select>
    </label>
  </div>

  <div class="stats">
    <p><strong>ATH:</strong> <span id="ath">–</span></p>
    <p><strong>Endring daglig:</strong> <span id="daily">–</span></p>
    <p><strong>Endring ukentlig:</strong> <span id="weekly">–</span></p>
    <p><strong>Endring månedlig:</strong> <span id="monthly">–</span></p>
    <p><strong>Endring årlig:</strong> <span id="yearly">–</span></p>
  </div>

  <canvas id="totalChart"></canvas>
  <canvas id="finnChart"></canvas>
  <canvas id="hjemChart"></canvas>

  <script>
    let rawData = [];

    async function loadData() {
      const res = await fetch('/data');
      rawData = await res.json();
      const cities = [...new Set(rawData.map(r => r.city))];
      const citySelect = document.getElementById('cityFilter');
      cities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        citySelect.appendChild(opt);
      });
      renderAll();
    }

    function filterData() {
      const city = document.getElementById('cityFilter').value;
      const category = document.getElementById('categoryFilter').value;
      return rawData.filter(row =>
        (city === 'ALL' || row.city === city) &&
        (category === 'ALL' || row.category === category)
      );
    }

    function groupByDate(data, key) {
      const result = {};
      data.forEach(row => {
        if (!result[row.date]) result[row.date] = 0;
        result[row.date] += Number(row[key]);
      });
      const labels = Object.keys(result).sort();
      const values = labels.map(l => result[l]);
      return { labels, values };
    }

    function getChange(values, days) {
      const last = values.at(-1);
      const prev = values.at(-1 - days);
      if (prev === undefined) return '–';
      const diff = last - prev;
      const sign = diff > 0 ? '+' : '';
      return sign + diff.toLocaleString('no-NO');
    }

    function updateStats(totalValues) {
      document.getElementById('ath').textContent = Math.max(...totalValues).toLocaleString('no-NO');
      document.getElementById('daily').textContent = getChange(totalValues, 1);
      document.getElementById('weekly').textContent = getChange(totalValues, 7);
      document.getElementById('monthly').textContent = getChange(totalValues, 30);
      document.getElementById('yearly').textContent = getChange(totalValues, 365);
    }

    let totalChart, finnChart, hjemChart;
    function drawChart(id, label, color, labels, values) {
      const ctx = document.getElementById(id).getContext('2d');
      if (window[id]) window[id].destroy();
      window[id] = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data: values,
            borderColor: color,
            backgroundColor: color === 'pink' ? 'rgba(255,192,203,0.2)' : 'transparent',
            fill: color === 'pink',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid: { display: false } },
            y: { grid: { display: false } }
          },
          plugins: { legend: { display: true } }
        }
      });
    }

    function renderAll() {
      const data = filterData();
      const total = groupByDate(data, 'total');
      const finn = groupByDate(data, 'finn');
      const hjem = groupByDate(data, 'hjem');

      updateStats(total.values);
      drawChart('totalChart', 'Totalt (Finn + Hjem)', 'pink', total.labels, total.values);
      drawChart('finnChart', 'Finn.no', 'blue', finn.labels, finn.values);
      drawChart('hjemChart', 'Hjem.no', 'green', hjem.labels, hjem.values);
    }

    document.getElementById('cityFilter').addEventListener('change', renderAll);
    document.getElementById('categoryFilter').addEventListener('change', renderAll);
    loadData();
  </script>
</body>
</html>
