<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Boliger til salgs â€“ OLX-stil</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 30px; background: #f7f7f7; }
    .controls { display: flex; gap: 20px; margin-bottom: 20px; }
    select, button { padding: 8px; font-size: 14px; }
    .charts { display: grid; grid-template-columns: 1fr; gap: 40px; }
    .chart-block { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .chart-block h2 { margin-bottom: 10px; }
    canvas { width: 100% !important; height: 300px !important; }
  </style>
</head>
<body>
  <h1>Totalt antall boliger til salgs</h1>

  <div class="controls">
    <select id="cityFilter">
      <option value="ALL">Alle byer</option>
      <option>Oslo</option>
      <option>Bergen</option>
      <option>Stavanger</option>
      <option>Trondheim</option>
      <option>Drammen</option>
    </select>
    <select id="catFilter">
      <option value="ALL">Alle kategorier</option>
      <option value="leiligheter">Leiligheter</option>
      <option value="eneboliger">Eneboliger</option>
      <option value="tomter">Tomter</option>
    </select>
    <button id="refresh">Oppdater</button>
  </div>

  <div class="charts">
    <div class="chart-block">
      <h2>Finn.no</h2>
      <canvas id="chartFinn"></canvas>
    </div>
    <div class="chart-block">
      <h2>Hjem.no</h2>
      <canvas id="chartHjem"></canvas>
    </div>
    <div class="chart-block">
      <h2>Totalt</h2>
      <canvas id="chartTotal"></canvas>
    </div>
  </div>

  <script>
    async function loadData() {
      const res = await fetch('/data');
      const raw = await res.json();
      return raw.map(r => ({
        date: r.date,
        city: r.city,
        category: r.category,
        finn: +r.finn,
        hjem: +r.hjem,
        total: +r.total
      }));
    }

    function filterData(data, city, cat) {
      return data.filter(d =>
        (city === 'ALL' || d.city === city) &&
        (cat === 'ALL' || d.category === cat)
      );
    }

    function aggregate(data) {
      const byDate = {};
      data.forEach(d => {
        if (!byDate[d.date]) byDate[d.date] = { finn:0, hjem:0, total:0 };
        byDate[d.date].finn += d.finn;
        byDate[d.date].hjem += d.hjem;
        byDate[d.date].total += d.total;
      });
      const dates = Object.keys(byDate).sort();
      return {
        labels: dates,
        finn: dates.map(d => byDate[d].finn),
        hjem: dates.map(d => byDate[d].hjem),
        total: dates.map(d => byDate[d].total)
      };
    }

    let chartFinn, chartHjem, chartTotal;

    async function draw() {
      const raw = await loadData();
      const city = document.getElementById('cityFilter').value;
      const cat  = document.getElementById('catFilter').value;
      const filtered = filterData(raw, city, cat);
      const series = aggregate(filtered);

      const cfgFinn = {
        type: 'line',
        data: {
          labels: series.labels,
          datasets: [{
            label: 'Finn.no',
            data: series.finn,
            borderColor: 'blue',
            fill: false,
            tension: 0.1,
            pointRadius: 5
          }]
        },
        options: { responsive: true, scales: { x: { grid: false }, y: { grid: false } } }
      };

      const cfgHjem = {
        type: 'line',
        data: {
          labels: series.labels,
          datasets: [{
            label: 'Hjem.no',
            data: series.hjem,
            borderColor: 'green',
            fill: false,
            tension: 0.1,
            pointRadius: 5
          }]
        },
        options: { responsive: true, scales: { x: { grid: false }, y: { grid: false } } }
      };

      const cfgTotal = {
        type: 'line',
        data: {
          labels: series.labels,
          datasets: [{
            label: 'Totalt',
            data: series.total,
            borderColor: 'pink',
            backgroundColor: 'rgba(255,192,203,0.2)',
            fill: true,
            tension: 0.1,
            pointRadius: 5
          }]
        },
        options: { responsive: true, scales: { x: { grid: false }, y: { grid: false } } }
      };

      if (chartFinn)  chartFinn.destroy();
      if (chartHjem)  chartHjem.destroy();
      if (chartTotal) chartTotal.destroy();

      chartFinn  = new Chart(document.getElementById('chartFinn').getContext('2d'), cfgFinn);
      chartHjem  = new Chart(document.getElementById('chartHjem').getContext('2d'), cfgHjem);
      chartTotal = new Chart(document.getElementById('chartTotal').getContext('2d'), cfgTotal);
    }

    document.getElementById('refresh').addEventListener('click', draw);
    window.addEventListener('load', draw);
  </script>
</body>
</html>
