<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Totalt antall boliger til salgs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 30px;
      background: #f7f7f7;
    }
    h1 {
      margin-bottom: 10px;
    }
    .stats {
      margin-bottom: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 300px;
    }
    canvas {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .wrapper {
      display: flex;
      flex-direction: row;
      gap: 40px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>Totalt antall boliger til salgs i Norge</h1>
  <div class="wrapper">
    <div class="stats">
      <p><strong>ATH:</strong> <span id="ath">–</span></p>
      <p><strong>Endring daglig:</strong> <span id="daily">–</span></p>
      <p><strong>Endring ukentlig:</strong> <span id="weekly">–</span></p>
      <p><strong>Endring månedlig:</strong> <span id="monthly">–</span></p>
      <p><strong>Endring årlig:</strong> <span id="yearly">–</span></p>
    </div>
    <canvas id="chart" width="800" height="400"></canvas>
  </div>

  <script>
    async function fetchData() {
      const response = await fetch('/data');
      const raw = await response.json();

      // Sumuj wszystkie dane total z każdego dnia
      const grouped = {};
      raw.forEach(row => {
        if (!grouped[row.date]) grouped[row.date] = 0;
        grouped[row.date] += Number(row.total);
      });

      const sortedDates = Object.keys(grouped).sort();
      const values = sortedDates.map(date => grouped[date]);

      // ATH
      const ath = Math.max(...values);
      document.getElementById('ath').textContent = ath.toLocaleString('no-NO');

      const getChange = (daysAgo) => {
        const last = values[values.length - 1];
        const past = values[values.length - 1 - daysAgo];
        if (past === undefined) return "–";
        const diff = last - past;
        const sign = diff > 0 ? "+" : "";
        return `${sign}${diff.toLocaleString('no-NO')}`;
      };

      document.getElementById('daily').textContent = getChange(1);
      document.getElementById('weekly').textContent = getChange(7);
      document.getElementById('monthly').textContent = getChange(30);
      document.getElementById('yearly').textContent = getChange(365);

      // Wykres
      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'Totalt (Finn + Hjem)',
            data: values,
            borderColor: 'pink',
            backgroundColor: 'rgba(255,192,203,0.2)',
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid: { display: false } },
            y: { grid: { display: false } }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>
