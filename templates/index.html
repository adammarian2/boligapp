<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Boliger til salgs – OLX-stil</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 30px; background: #f7f7f7; }
    .controls { display: flex; gap: 20px; margin-bottom: 20px; }
    select, button { padding: 8px; font-size: 14px; }
    .stats { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
    canvas { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); width: 100% !important; height: 400px !important; }
  </style>
</head>
<body>
  <h1>Totalt antall boliger til salgs</h1>

  <div class="controls">
    <select id="cityFilter">
      <option value="ALL">Alle byer</option>
      <option>Oslo</option>
      <option>Bergen</option>
      <option>Stavanger</option>
      <option>Trondheim</option>
      <option>Drammen</option>
    </select>
    <select id="catFilter">
      <option value="ALL">Alle kategorier</option>
      <option value="leiligheter">Leiligheter</option>
      <option value="eneboliger">Eneboliger</option>
      <option value="tomter">Tomter</option>
    </select>
    <button id="refresh">Oppdater</button>
  </div>

  <div class="stats">
    <div class="stat"><strong>ATH:</strong> <span id="stat-ath">–</span></div>
    <div class="stat"><strong>Daglig:</strong> <span id="stat-daily">–</span></div>
    <div class="stat"><strong>Ukentlig:</strong> <span id="stat-weekly">–</span></div>
    <div class="stat"><strong>Månedlig:</strong> <span id="stat-monthly">–</span></div>
    <div class="stat"><strong>Årlig:</strong> <span id="stat-yearly">–</span></div>
  </div>

  <canvas id="chart"></canvas>

  <script>
    async function loadData() {
      const res = await fetch('/data');
      const raw = await res.json();
      return raw.map(r => ({
        date: r.date,
        city: r.city,
        category: r.category,
        finn: +r.finn,
        hjem: +r.hjem,
        total: +r.total
      }));
    }

    function filterData(data, city, cat) {
      return data.filter(d =>
        (city === 'ALL' || d.city === city) &&
        (cat === 'ALL' || d.category === cat)
      );
    }

    function aggregate(data) {
      const byDate = {};
      data.forEach(d => {
        if (!byDate[d.date]) byDate[d.date] = { finn:0, hjem:0, total:0 };
        byDate[d.date].finn += d.finn;
        byDate[d.date].hjem += d.hjem;
        byDate[d.date].total += d.total;
      });
      const dates = Object.keys(byDate).sort();
      return {
        labels: dates,
        finn: dates.map(d => byDate[d].finn),
        hjem: dates.map(d => byDate[d].hjem),
        total: dates.map(d => byDate[d].total)
      };
    }

    function calcStats(series) {
      const arr = series.total;
      const n = arr.length;
      if (n === 0) return {};
      const ath = Math.max(...arr);
      const last = arr[n-1];
      function ch(days) {
        if (n-1-days < 0) return '–';
        const diff = last - arr[n-1-days];
        return (diff>0?'+':'') + diff;
      }
      return {
        ath, daily:ch(1), weekly:ch(7), monthly:ch(30), yearly:ch(365)
      };
    }

    let chart;
    async function draw() {
      const raw = await loadData();
      const city = document.getElementById('cityFilter').value;
      const cat  = document.getElementById('catFilter').value;
      const filtered = filterData(raw, city, cat);
      const series = aggregate(filtered);
      const stats = calcStats(series);

      document.getElementById('stat-ath').textContent = stats.ath ?? '–';
      document.getElementById('stat-daily').textContent = stats.daily ?? '–';
      document.getElementById('stat-weekly').textContent = stats.weekly ?? '–';
      document.getElementById('stat-monthly').textContent = stats.monthly ?? '–';
      document.getElementById('stat-yearly').textContent = stats.yearly ?? '–';

      const data = {
        labels: series.labels,
        datasets: [
          { label:'Finn.no', data:series.finn, borderColor:'blue', fill:false, tension:0.1 },
          { label:'Hjem.no', data:series.hjem, borderColor:'green', fill:false, tension:0.1 },
          { label:'Totalt', data:series.total, borderColor:'pink', backgroundColor:'rgba(255,192,203,0.2)', fill:true, tension:0.1 }
        ]
      };

      const cfg = { type:'line', data, options:{ responsive:true, scales:{ x:{ grid:false }, y:{ grid:false } } } };

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('chart').getContext('2d'), cfg);
    }

    document.getElementById('refresh').addEventListener('click', draw);
    window.addEventListener('load', draw);
  </script>
</body>
</html>
